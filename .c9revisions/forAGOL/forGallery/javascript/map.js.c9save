{"ts":1351879382319,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"  dojo.require(\"esri.map\");\n  dojo.require(\"esri.dijit.Legend\");\n  dojo.require(\"esri.dijit.Scalebar\");\n  dojo.require(\"esri.arcgis.utils\");\n  dojo.require(\"esri.IdentityManager\");\n  dojo.require(\"dijit.dijit\"); // optimize: load dijit layer\n  dojo.require(\"dijit.layout.BorderContainer\");\n  dojo.require(\"dijit.layout.ContentPane\");\n  dojo.require(\"dijit.layout.StackContainer\");\n  dojo.require(\"esri.tasks.query\");\n  dojo.requireLocalization(\"esriTemplate\",\"template\");\n  \n  \n    var map, urlObject;\n\tvar mapChange = false;\n\tvar mapExtent;\n\tvar firstMap = false;\n\tvar mapsLoaded = 1;\n\tvar i18n;\n\t \n     function initMap() {\n      patchID();\n      \n\t  i18n = dojo.i18n.getLocalization(\"esriTemplate\",\"template\");\n\t  \n\t  dojo.byId('loadText').innerHTML = i18n.viewer.loading.message;\n\t  dojo.byId('syncHead').innerHTML = i18n.viewer.sync.head;\n\t  dojo.byId('scale').innerHTML = i18n.viewer.sync.scale;\n\t  dojo.byId('location').innerHTML = i18n.viewer.sync.location;\n\t  dojo.byId('legText').innerHTML = i18n.viewer.toggles.legend;\n\t  dojo.byId('desText').innerHTML = i18n.viewer.toggles.description;\n\t  \n      if(configOptions.geometryserviceurl && location.protocol === \"https:\"){\n        configOptions.geometryserviceurl = configOptions.geometryserviceurl.replace('http:','https:');\n      }\n      esri.config.defaults.geometryService = new esri.tasks.GeometryService(configOptions.geometryserviceurl);  \n      \n\n\n      if(!configOptions.sharingurl){\n        configOptions.sharingurl = location.protocol + '//' + location.host + \"/sharing/content/items\";\n      }\n      esri.arcgis.utils.arcgisUrl = configOptions.sharingurl;\n       \n      if(!configOptions.proxyurl){   \n        configOptions.proxyurl = location.protocol + '//' + location.host + \"/sharing/proxy\";\n      }\n\n      esri.config.defaults.io.proxyUrl =  configOptions.proxyurl;\n\n      esri.config.defaults.io.alwaysUseProxy = false;\n      \n      urlObject = esri.urlToObject(document.location.href);\n      urlObject.query = urlObject.query || {};\n\t  \n\t  if(urlObject.query.title){\n        configOptions.title = urlObject.query.title;\n      }\n      if(urlObject.query.subtitle){\n        configOptions.title = urlObject.query.subtitle;\n      }\n      if(urlObject.query.webmap){\n        if (dojo.isArray(urlObject.query.webmap) == false){\n        \tconfigOptions.webmaps[0].id = urlObject.query.webmap;\n\t\t\tconfigOptions.webmaps[1].id = urlObject.query.webmap;\n\t\t  }\n\t\t  else{\n\t\t\tdojo.forEach(urlObject.query.webmap,function(webmap,i){\n\t\t\t  configOptions.webmaps[i] = {\"id\": webmap};\n\t\t\t});\n\t\t  }\n      } \n      if(urlObject.query.bingMapsKey){\n        configOptions.bingmapskey = urlObject.query.bingMapsKey;      \n      }\n\t  \n\t  //is an appid specified - if so read json from there\n\t  if(configOptions.appid || (urlObject.query && urlObject.query.appid)){\n\t\tvar appid = configOptions.appid || urlObject.query.appid;\n\t\tvar requestHandle = esri.request({\n\t\t  url: configOptions.sharingurl + \"/\" + appid + \"/data\",\n\t\t  content: {f:\"json\"},\n\t\t  callbackParamName:\"callback\",\n\t\t  load: function(response){\n\t\t\t   if(response.values.title !== undefined){configOptions.title = response.values.title;}\n\t\t\t   if(response.values.subtitle !== undefined){configOptions.subtitle = response.values.subtitle;}\n\t\t\t   if(response.values.description !== undefined){configOptions.description = response.values.description; }\n\t\t\t   if(response.values.legend !== undefined) {configOptions.legend = response.values.legend;}\n\t\t\t   if(response.values.webmaps !== undefined) {configOptions.webmaps = getWebMaps(response.values.webmaps);}\n    \n\t\t\t   initMaps();\n\t  \t\t   bannerSetup();\n\t\t  },\n\t\t  error: function(response){\n\t\t\tvar e = response.message;\n\t\t   alert(i18n.viewer.errors.createMap +  response.message);\n\t\t  }\n\t\t});\n\t\t }else{\n\t\t\tinitMaps();\n\t \t\tbannerSetup();\n\t\t }\n\t  \n      }\n    \n    \n    function createMap(j){\n\t  \n\t  esriConfig.defaults.map.slider = { left:200 };\n\n\n      var mapDeferred = esri.arcgis.utils.createMap(configOptions.webmaps[j].id, \"mapDiv\"+[j], {\n        mapOptions: {\n          slider: true,\n          nav: false,\n          wrapAround180: true,\n\t\t  extent: mapExtent\n        },\n        ignorePopups:false,\n        bingMapsKey: configOptions.bingmapskey\n      });\n\n      mapDeferred.addCallback(function (response) {\n\t\t  \n\t\tdojo.byId(\"title\"+[j]).innerHTML = response.itemInfo.item.title;\n        dojo.byId(\"description\"+[j]).innerHTML = response.itemInfo.item.description;\n        \n        eval(\"map\"+[j]+\" = response.map\");\n\n\t\tdojo.connect(eval(\"map\"+[j]),\"onUpdateEnd\",hideLoader);\n\t\tdojo.connect(eval(\"map\"+[j]),\"onExtentChange\",syncMaps);\n\t\tdojo.connect(eval(\"map\"+[j]),\"onPanEnd\",enableSyncing);\n\t\tdojo.connect(eval(\"map\"+[j]),\"onZoomEnd\",enableSyncing);\n\t\t\n        var layers = response.itemInfo.itemData.operationalLayers;\n        if(eval(\"map\"+[j]).loaded){\n          initUI(layers,j);\n\t\t  $(\".esriSimpleSlider\").css(\"left\",($(\".map\").width()-42));\n\t\t  $(\"#mapDiv1_zoom_slider\").css(\"left\",($(\"#mapDiv1\").width()-42));\n        }\n        else{\n          dojo.connect(eval(\"map\"+[j]),\"onLoad\",function(){\n            initUI(layers,j);\n\t\t\t$(\".esriSimpleSlider\").css(\"left\",($(\".map\").width()-42));\n\t\t\t$(\"#mapDiv1_zoom_slider\").css(\"left\",($(\"#mapDiv1\").width()-42));\n          });\n        }\n       });\n\n      mapDeferred.addErrback(function (error) {\n          alert(i18n.viewer.errors.createMap + \" \" + dojo.toJson(error.message));\n      });\n\n\n    \n    }\n\n    function initUI(layers,j) {\n      //add chrome theme for popup\n      dojo.addClass(eval(\"map\"+[j]).infoWindow.domNode, \"chrome\");\n      //add the scalebar \n\t  /*\n      var scalebar = new esri.dijit.Scalebar({\n        map: eval(\"map\"+[j]),\n        scalebarUnit:i18n.viewer.main.scaleBarUnits //metric or english\n      });\n\t  */\n      var layerInfo = buildLayersList(layers);      \n      \n      if(layerInfo.length > 0){\n        var legendDijit = new esri.dijit.Legend({\n          map:eval(\"map\"+[j]),\n          layerInfos:layerInfo\n        },'legend'+[j]);\n        legendDijit.startup();\n      }\n      else{\n        dojo.byId('legend'+[j]).innerHTML = 'No Legend';\n      }\n\t  \n    }\n//build a list of layers to dispaly in the legend\n  function buildLayersList(layers){\n\n //layers  arg is  response.itemInfo.itemData.operationalLayers;\n  var layerInfos = [];\n  dojo.forEach(layers, function (mapLayer, index) {\n      var layerInfo = {};\n      if (mapLayer.featureCollection && mapLayer.type !== \"CSV\") {\n        if (mapLayer.featureCollection.showLegend === true) {\n            dojo.forEach(mapLayer.featureCollection.layers, function (fcMapLayer) {\n              if (fcMapLayer.showLegend !== false) {\n                  layerInfo = {\n                      \"layer\": fcMapLayer.layerObject,\n                      \"title\": mapLayer.title,\n                      \"defaultSymbol\": false\n                  };\n                  if (mapLayer.featureCollection.layers.length > 1) {\n                      layerInfo.title += \" - \" + fcMapLayer.layerDefinition.name;\n                  }\n                  layerInfos.push(layerInfo);\n              }\n            });\n          }\n      } else if (mapLayer.showLegend !== false && mapLayer.layerObject) {\n      var showDefaultSymbol = false;\n      if (mapLayer.layerObject.version < 10.1 && (mapLayer.layerObject instanceof esri.layers.ArcGISDynamicMapServiceLayer || mapLayer.layerObject instanceof esri.layers.ArcGISTiledMapServiceLayer)) {\n        showDefaultSymbol = true;\n      }\n      layerInfo = {\n        \"layer\": mapLayer.layerObject,\n        \"title\": mapLayer.title,\n        \"defaultSymbol\": showDefaultSymbol\n      };\n        //does it have layers too? If so check to see if showLegend is false\n        if (mapLayer.layers) {\n            var hideLayers = dojo.map(dojo.filter(mapLayer.layers, function (lyr) {\n                return (lyr.showLegend === false);\n            }), function (lyr) {\n                return lyr.id;\n            });\n            if (hideLayers.length) {\n                layerInfo.hideLayers = hideLayers;\n            }\n        }\n        layerInfos.push(layerInfo);\n    }\n  });\n  return layerInfos;\n  }\n    \n     function patchID() {  //patch id manager for use in apps.arcgis.com\n       esri.id._isIdProvider = function(server, resource) {\n       // server and resource are assumed one of portal domains\n \n       var i = -1, j = -1;\n \n       dojo.forEach(this._gwDomains, function(domain, idx) {\n         if (i === -1 && domain.regex.test(server)) {\n           i = idx;\n         }\n         if (j === -1 && domain.regex.test(resource)) {\n           j = idx;\n         }\n       });\n \n       var retVal = false;\n   \n       if (i > -1 && j > -1) {\n         if (i === 0 || i === 4) {\n           if (j === 0 || j === 4) {\n             retVal = true;\n           }\n         }\n         else if (i === 1) {\n           if (j === 1 || j === 2) {\n             retVal = true;\n           }\n         }\n         else if (i === 2) {\n           if (j === 2) {\n             retVal = true;\n           }\n         }\n         else if (i === 3) {\n           if (j === 3) {\n             retVal = true;\n           }\n         }\n       }\n \n       return retVal;\n     };    \n    }\n\t\n\tfunction setExtent(){\n\t\tif (configOptions.syncMaps == true){\n\t\t\tif (firstMap == false){\n\t\t\t\tmapExtent = map0.extent();\n\t\t\t\tfirstMap = true;\n\t\t\t}\n\t\t}\n\t}\n\t\n\tfunction hideLoader(){\n\t\tif (mapsLoaded == configOptions.webmaps.length){\n\t\t\t$(\"#loadingCon\").hide();\n\t\t\tif(configOptions.webmaps.length == 2){\n\t\t\t\t$(\"#mapDiv1_zoom_slider\").show();\n\t\t\t}\n\t\t}\n\t\telse{\n\t\t\tmapsLoaded++\n\t\t}\n\t\t$(\".esriSimpleSlider\").css(\"left\",($(\".map\").width()-42));\n\t\t$(\"#mapDiv1_zoom_slider\").css(\"left\",($(\"#mapDiv1\").width()-42));\n\t}\n\t\n\tfunction resizeMaps(){\n\t\tif(map0 != null){\n\t\t\tmap0.resize();\n\t\t}\n\t\tif(map1 != null){\n\t\t\tmap1.resize();\n\t\t}\n\t\tif(map2 != null){\n\t\t\tmap2.resize();\n\t\t}\n\t}\n\t\n\t$(window).resize(function(e) {\n\t\tresizeMaps();\n    });\n\t\n\tfunction getWebMaps(webmaps) {\n\t  if (webmaps.indexOf(',') !== -1) {\n\t\tvar mapIds = webmaps.split(',');\n\t\twebmapresults = dojo.map(mapIds, function (mapId) {\n\t\t  return {\n\t\t\tid: mapId\n\t\t  };\n\t\t});\n\t  } else {\n\t\tvar previewWebMap = {\n\t\t  id: webmaps\n\t\t};\n\t\twebmapresults = [previewWebMap, previewWebMap, previewWebMap];\n\t  }\n\t  \n\t  if (webmapresults.length < 2){\n\t\t  webmapresults[1] = webmapresults[0];\n\t  }\n\t  \n\t  return webmapresults;\n\t}"]],"start1":0,"start2":0,"length1":0,"length2":10310}]],"length":10310}
{"contributors":[],"silentsave":true,"ts":1351879685319,"patch":[[{"diffs":[[0,"hide();\n"],[1,"            \n            syncMaps();\n"],[0,"\t\t\tif(co"]],"start1":9398,"start2":9398,"length1":16,"length2":53}]],"length":10347,"saved":false}
{"ts":1351879686434,"patch":[[{"diffs":[[0,"();\n"],[-1,"            \n            syncMaps();\n"],[0,"\t\t\ti"]],"start1":9402,"start2":9402,"length1":45,"length2":8}]],"length":10310,"saved":false}
{"ts":1351879687296,"patch":[[{"diffs":[[0,"hide();\n"],[1,"            syncMaps();\n"],[0,"\t\t\tif(co"]],"start1":9398,"start2":9398,"length1":16,"length2":40}]],"length":10334,"saved":false}
{"ts":1351879749748,"patch":[[{"diffs":[[0,"    var "],[-1,"map,"],[0," urlObje"]],"start1":478,"start2":478,"length1":20,"length2":16}]],"length":10330,"saved":false}
{"ts":1351879751034,"patch":[[{"diffs":[[0,"    var "],[-1," "],[0,"urlObjec"]],"start1":478,"start2":478,"length1":17,"length2":16}]],"length":10329,"saved":false}
